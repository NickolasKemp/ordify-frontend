<section class="order-page">
	<!-- Крок 1: Огляд замовлення -->
	<div *ngIf="currentStep() === 'review'" class="order-step">
		<!-- Customer type toggle -->
		<div class="customer-type-toggle">
			<button
				mat-stroked-button
				[class.active]="orderMode() === 'new'"
				(click)="switchToNewCustomer()"
			>
				<mat-icon>person_add</mat-icon>
				New Customer
			</button>
			<button
				mat-stroked-button
				[class.active]="orderMode() === 'returning'"
				(click)="switchToReturningCustomer()"
			>
				<mat-icon>person</mat-icon>
				Returning Customer
			</button>
		</div>

		<!-- Returning customer: Token input -->
		<div *ngIf="orderMode() === 'returning'" class="token-section">
			<h3>Enter Your Client Token</h3>
			<p class="token-description">
				If you have placed an order before, enter your client token to use your
				existing agreement.
			</p>
			<form [formGroup]="tokenData" class="token-form">
				<mat-form-field appearance="outline" class="full-width">
					<mat-label>Client Token</mat-label>
					<input
						formControlName="clientToken"
						matInput
						placeholder="Enter your client token"
					/>
					<mat-icon matSuffix>vpn_key</mat-icon>
					<mat-error *ngIf="tokenValidationError()">
						{{ tokenValidationError() }}
					</mat-error>
				</mat-form-field>
				<button
					mat-flat-button
					type="button"
					[disabled]="isValidatingToken()"
					(click)="validateClientToken(tokenData.get('clientToken')?.value)"
				>
					{{ isValidatingToken() ? "Validating..." : "Validate Token" }}
				</button>
			</form>

			<!-- Show agreement info when token is valid -->
			<div *ngIf="currentAgreement()" class="agreement-info">
				<mat-icon class="success-icon">check_circle</mat-icon>
				<h4>Token Valid!</h4>
				<p>
					<strong>Customer:</strong> {{ currentAgreement()?.customer?.name }}
				</p>
				<p>
					<strong>Agreement valid until:</strong>
					{{ currentAgreement()?.ends_at | date: "mediumDate" }}
				</p>
			</div>
		</div>

		<!-- New customer: Customer form -->
		<div *ngIf="orderMode() === 'new'">
			<app-customer-form
				[errorMessages]="errorMessages().customer"
				[formGroup]="customerData"
			></app-customer-form>

			<!-- Agreement Period Selection -->
			<div class="agreement-section">
				<h3>Agreement Period</h3>
				<p class="section-description">
					Select how long you want your agreement to be valid.
				</p>
				<form [formGroup]="agreementData">
					<mat-form-field appearance="outline" class="full-width">
						<mat-label>Agreement Duration</mat-label>
						<mat-select formControlName="period">
							<mat-option
								*ngFor="let option of agreementPeriodOptions"
								[value]="option.value"
							>
								{{ option.label }}
							</mat-option>
						</mat-select>
					</mat-form-field>
				</form>
			</div>

			<!-- Legal Entity Form -->
			<div class="legal-entity-section">
				<h3>Legal Entity Information</h3>
				<p class="section-description">
					Please provide your company's legal details for the agreement.
				</p>
				<form [formGroup]="legalEntityData" class="legal-entity-form">
					<mat-form-field appearance="outline" class="full-width">
						<mat-label>Company Name</mat-label>
						<input formControlName="name" matInput required />
						<mat-icon matSuffix>business</mat-icon>
					</mat-form-field>

					<div class="form-row">
						<mat-form-field appearance="outline">
							<mat-label>Registration Number</mat-label>
							<input formControlName="registrationNumber" matInput required />
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Director Name</mat-label>
							<input formControlName="directorName" matInput required />
							<mat-icon matSuffix>person</mat-icon>
						</mat-form-field>
					</div>

					<h4>Legal Address</h4>
					<div formGroupName="legalAddress">
						<mat-form-field appearance="outline" class="full-width">
							<mat-label>Street</mat-label>
							<input formControlName="street" matInput required />
						</mat-form-field>
						<div class="form-row">
							<mat-form-field appearance="outline">
								<mat-label>City</mat-label>
								<input formControlName="city" matInput required />
							</mat-form-field>
							<mat-form-field appearance="outline">
								<mat-label>State</mat-label>
								<input formControlName="state" matInput required />
							</mat-form-field>
							<mat-form-field appearance="outline">
								<mat-label>ZIP Code</mat-label>
								<input formControlName="zip" matInput required />
							</mat-form-field>
						</div>
					</div>

					<h4>Bank Account</h4>
					<div formGroupName="bankAccount">
						<div class="form-row">
							<mat-form-field appearance="outline">
								<mat-label>Bank Name</mat-label>
								<input formControlName="name" matInput required />
								<mat-icon matSuffix>account_balance</mat-icon>
							</mat-form-field>
							<mat-form-field appearance="outline">
								<mat-label>IBAN</mat-label>
								<input formControlName="iban" matInput required />
							</mat-form-field>
						</div>
					</div>
				</form>
			</div>
		</div>

		<h3 class="order-page__buying-title">You're buying</h3>

		<div *ngIf="product$ | async as product" class="product-preview">
			<div class="product-preview__image">
				<img src="{{ product.image }}" alt="" />
			</div>
			<h3 class="product-preview__name">{{ product.name }}</h3>
		</div>

		<form
			*ngIf="product$ | async as product"
			[formGroup]="productData"
			class="product-form"
		>
			<mat-form-field appearance="outline" floatLabel="always">
				<mat-label>Amount</mat-label>
				<input
					formControlName="quantity"
					min="1"
					[max]="product$.getValue()?.quantity!"
					matInput
					type="number"
					required
					(change)="calcTotal()"
				/>
				<mat-error>
					{{ errorMessages().product["quantity"] }}
				</mat-error>
				<span class="order-page__quantity-count" matTextSuffix>
					/ {{ product$.getValue()?.quantity }}</span
				>
			</mat-form-field>
			<mat-form-field appearance="outline">
				<mat-label>Delivery</mat-label>
				<mat-select formControlName="deliveryWay">
					<mat-option
						(click)="onDeliveryWayChange(option.type, product.deliveryOptions)"
						*ngFor="let option of product.deliveryOptions"
						[value]="option.type"
						>{{ option.type }}</mat-option
					>
				</mat-select>
			</mat-form-field>
			<div>
				<div
					class="order-page__delivery-option-details"
					*ngIf="
						findDeliveryOptionByDeliveryWay(
							productData.get('deliveryWay')!.value,
							product.deliveryOptions
						) as deliveryOption
					"
				>
					<span>Period</span>
					<p>
						{{ deliveryOption.period }}
					</p>
					<span>Price</span>
					<p>
						{{ deliveryOption.price | currency }}
					</p>
				</div>
			</div>
		</form>

		<p class="order-page__total">Total: {{ totalPrice() | currency }}</p>

		<div class="order-page__button">
			<button [disabled]="isLoading()" (click)="onPlaceOrder()" mat-flat-button>
				Place order
			</button>
		</div>
	</div>

	<!-- Крок 2: Оплата -->
	<div *ngIf="currentStep() === 'payment'" class="order-step payment-step">
		<div class="payment-header">
			<button mat-icon-button (click)="onBackToReview()">
				<mat-icon>arrow_back</mat-icon>
			</button>
			<h2>Payment</h2>
		</div>

		<!-- Show client token for new customers -->
		<div *ngIf="newClientToken()" class="client-token-display">
			<div class="token-header">
				<mat-icon>vpn_key</mat-icon>
				<h3>Your Client Token</h3>
			</div>
			<p class="token-description">
				Save this token! You'll need it for future orders under your agreement.
			</p>
			<div class="token-value">
				<code>{{ newClientToken() }}</code>
				<button mat-icon-button (click)="copyToken()" title="Copy token">
					<mat-icon>content_copy</mat-icon>
				</button>
			</div>
		</div>

		<div class="payment-summary">
			<h3>Order Summary</h3>
			<div *ngIf="product$ | async as product" class="payment-product">
				<span>{{ product.name }}</span>
				<span>x{{ productData.get("quantity")?.value }}</span>
			</div>
			<p class="payment-total">Total: {{ totalPrice() | currency }}</p>
		</div>

		<div class="payment-form-container">
			<h3>Card Details</h3>
			<p class="stripe-test-notice">
				<mat-icon>info</mat-icon>
				Use test card: 4242 4242 4242 4242
			</p>

			<form [formGroup]="paymentData" class="payment-form">
				<mat-form-field appearance="outline" class="full-width">
					<mat-label>Card Number</mat-label>
					<input
						formControlName="cardNumber"
						matInput
						placeholder="4242 4242 4242 4242"
						maxlength="19"
					/>
					<mat-icon matSuffix>credit_card</mat-icon>
					<mat-error>Enter a valid card number</mat-error>
				</mat-form-field>

				<div class="payment-row">
					<mat-form-field appearance="outline">
						<mat-label>Month</mat-label>
						<input
							formControlName="expMonth"
							matInput
							placeholder="MM"
							maxlength="2"
						/>
						<mat-error>Invalid</mat-error>
					</mat-form-field>

					<mat-form-field appearance="outline">
						<mat-label>Year</mat-label>
						<input
							formControlName="expYear"
							matInput
							placeholder="YY"
							maxlength="2"
						/>
						<mat-error>Invalid</mat-error>
					</mat-form-field>

					<mat-form-field appearance="outline">
						<mat-label>CVC</mat-label>
						<input
							formControlName="cvc"
							matInput
							placeholder="123"
							maxlength="4"
							type="password"
						/>
						<mat-error>Invalid</mat-error>
					</mat-form-field>
				</div>
			</form>

			<div *ngIf="paymentError()" class="payment-error">
				<mat-icon>error</mat-icon>
				{{ paymentError() }}
			</div>

			<div class="order-page__button">
				<button
					[disabled]="isLoading() || paymentData.invalid"
					(click)="onConfirmPayment()"
					mat-flat-button
					color="primary"
				>
					<mat-icon *ngIf="isLoading()">hourglass_empty</mat-icon>
					{{
						isLoading() ? "Processing..." : "Pay " + (totalPrice() | currency)
					}}
				</button>
			</div>
		</div>
	</div>
</section>
